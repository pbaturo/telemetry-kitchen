services:
  # Message Broker
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: telemetry-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: telemetry
      RABBITMQ_DEFAULT_PASS: telemetry123
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - telemetry-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  # Database
  postgres:
    image: postgres:16
    container_name: telemetry-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: telemetry
      POSTGRES_PASSWORD: telemetry123
      POSTGRES_DB: telemetry_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - telemetry-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U telemetry"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Blob Storage
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: telemetry-azurite
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    volumes:
      - azurite-data:/data
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0"
    networks:
      - telemetry-network

  # Monitoring - Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: telemetry-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - telemetry-network

  # Visualization - Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: telemetry-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: telemetry123
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
      - ./config/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - postgres
    networks:
      - telemetry-network

  # Analytics - Metabase
  metabase:
    image: metabase/metabase:latest
    container_name: telemetry-metabase
    ports:
      - "3001:3000"
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: telemetry_db
      MB_DB_PORT: 5432
      MB_DB_USER: telemetry
      MB_DB_PASS: telemetry123
      MB_DB_HOST: postgres
    depends_on:
      - postgres
    networks:
      - telemetry-network

  # Gateway Service
  gateway:
    build:
      context: ./src/Gateway
      dockerfile: Dockerfile
    container_name: telemetry-gateway
    ports:
      - "8080:8080"
      - "9091:9091"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: telemetry
      RabbitMQ__Password: telemetry123
      Azurite__ConnectionString: DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;
      Metrics__Port: 9091
      Polling__IntervalSeconds: 30
    depends_on:
      rabbitmq:
        condition: service_healthy
      azurite:
        condition: service_started
    networks:
      - telemetry-network
    restart: unless-stopped

  # Consumer Service
  consumer:
    build:
      context: ./src/Consumer
      dockerfile: Dockerfile
    container_name: telemetry-consumer
    ports:
      - "9092:9092"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: telemetry
      RabbitMQ__Password: telemetry123
      Database__ConnectionString: Host=postgres;Database=telemetry_db;Username=telemetry;Password=telemetry123
      Metrics__Port: 9092
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - telemetry-network
    restart: unless-stopped

networks:
  telemetry-network:
    driver: bridge

volumes:
  rabbitmq-data:
  postgres-data:
  azurite-data:
  prometheus-data:
  grafana-data:
