%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#1e1e1e','primaryTextColor':'#fff','primaryBorderColor':'#7c3aed','lineColor':'#6366f1','secondaryColor':'#2e7d32','tertiaryColor':'#0288d1'}}}%%
flowchart TB
  %% ==============================================
  %% DATA SOURCES (External APIs - Phase 1)
  %% ==============================================
  subgraph EXT["ğŸŒ DATA SOURCES - External Public APIs"]
    direction LR
    OS["ğŸ“¡ OpenSenseMap<br/>Environmental Sensors"]
    SC["ğŸŒ«ï¸ Sensor.Community<br/>Air Quality Network"]
    USGS["ğŸ’§ USGS Water Services<br/>Hydrology Data"]
  end

  %% ==============================================
  %% INGESTION PROCESS (Core Data Pipeline)
  %% ==============================================
  subgraph INGEST["âš™ï¸ INGESTION PROCESS - Telemetry Kitchen"]
    direction TB
    
    subgraph GATEWAY["Gateway Layer"]
      GP["ğŸ”„ Gateway.Poller<br/>.NET 9<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Polls external APIs<br/>â€¢ Normalizes events<br/>â€¢ Publishes to queue<br/>â€¢ Exposes /metrics"]
    end
    
    subgraph QUEUE["Message Broker"]
      MQ[("ğŸ’¾ RabbitMQ<br/>â”â”â”â”â”â”â”â”<br/>Durability Gate<br/>Topic Exchange")]
    end
    
    subgraph CONSUMER["Consumer Layer"]
      IC["ğŸ“¥ Ingest.Consumer<br/>.NET 9<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Consumes queue<br/>â€¢ Idempotency check<br/>â€¢ Writes to DB<br/>â€¢ Exposes /metrics"]
    end
    
    subgraph STORAGE["Data Storage"]
      DB[("ğŸ—„ï¸ PostgreSQL 17<br/>â”â”â”â”â”â”â”â”<br/>Single Instance<br/>Naive baseline schema<br/>sensor_events table")]
    end
    
    GP --> MQ
    MQ --> IC
    IC --> DB
  end

  %% ==============================================
  %% OBSERVABILITY (Monitoring & Logging)
  %% ==============================================
  subgraph OBS["ğŸ“Š OBSERVABILITY STACK"]
    direction TB
    
    subgraph COLLECT["Metrics Collection"]
      PGX["ğŸ“ˆ postgres_exporter<br/>DB metrics"]
      NEX["ğŸ’» node_exporter<br/>System metrics"]
    end
    
    subgraph TSDB["Time Series Storage"]
      PROM[("â±ï¸ Prometheus<br/>â”â”â”â”â”â”â”â”<br/>Scrapes every 10s<br/>Stores metrics")]
      LOKI[("ğŸ“ Loki<br/>â”â”â”â”â”â”â”â”<br/>Log aggregation<br/>JSON labels")]
    end
    
    subgraph VIZ["Visualization"]
      GRAF["ğŸ“‰ Grafana<br/>â”â”â”â”â”â”â”â”<br/>â€¢ Operational Dashboard<br/>â€¢ Sensor Overview<br/>â€¢ Logs Explorer"]
    end
    
    PGX -.->|scrape| PROM
    NEX -.->|scrape| PROM
    PROM -.->|query| GRAF
    LOKI -.->|query| GRAF
  end

  %% ==============================================
  %% CLIENT AREA (Applications & Analytics)
  %% ==============================================
  subgraph CLIENT["ğŸ‘¥ CLIENT AREA - Applications"]
    direction TB
    
    subgraph WEB["Web Applications"]
      MVC["ğŸŒ Web.Mvc<br/>.NET 9 MVC<br/>â”â”â”â”â”â”â”â”<br/>Read-only UI<br/>Sensor status<br/>History views<br/><i>Phase 2</i>"]
    end
    
    subgraph ANALYTICS["Analytics & BI"]
      META["ğŸ“Š Metabase<br/>â”â”â”â”â”â”â”â”<br/>Self-hosted<br/>Ad-hoc queries<br/>Custom dashboards<br/><i>Phase 2</i>"]
    end
    
    subgraph FUTURE["Future Capabilities"]
      AZ[("â˜ï¸ Azurite<br/>â”â”â”â”â”â”â”â”<br/>Azure Blob compatible<br/>Camera snapshots<br/>Media storage<br/><i>Phase 2</i>")]
    end
  end

  %% ==============================================
  %% CONNECTIONS - Data Sources to Ingestion
  %% ==============================================
  OS -->|"HTTP GET<br/>JSON"| GP
  SC -->|"HTTP GET<br/>JSON"| GP
  USGS -->|"HTTP GET<br/>JSON"| GP

  %% ==============================================
  %% CONNECTIONS - Ingestion to Observability
  %% ==============================================
  GP -.->|"/metrics endpoint"| PROM
  IC -.->|"/metrics endpoint"| PROM
  MQ -.->|"built-in /metrics"| PROM
  DB --> PGX
  GP -.->|"Serilog logs"| LOKI
  IC -.->|"Serilog logs"| LOKI

  %% ==============================================
  %% CONNECTIONS - Storage to Client Area
  %% ==============================================
  DB -->|"read queries"| MVC
  DB -->|"read queries"| META

  %% ==============================================
  %% CONNECTIONS - Phase 2 Future
  %% ==============================================
  GP -.->|"store blobs<br/><i>Phase 2</i>"| AZ
  IC -.->|"blobRef metadata<br/><i>Phase 2</i>"| DB

  %% ==============================================
  %% STYLING - Color-coded by functional area
  %% ==============================================
  
  %% Data Sources - Blue
  classDef dataSource fill:#0288d1,stroke:#01579b,stroke-width:3px,color:#fff
  class OS,SC,USGS dataSource
  
  %% Ingestion - Green
  classDef ingestion fill:#2e7d32,stroke:#1b5e20,stroke-width:3px,color:#fff
  class GP,MQ,IC,DB ingestion
  
  %% Observability - Purple
  classDef observability fill:#7c3aed,stroke:#5b21b6,stroke-width:3px,color:#fff
  class PGX,NEX,PROM,LOKI,GRAF observability
  
  %% Client Area - Orange
  classDef client fill:#f57c00,stroke:#e65100,stroke-width:3px,color:#fff
  class MVC,META client
  
  %% Future/Phase 2 - Gray (dashed)
  classDef future fill:#616161,stroke:#424242,stroke-width:2px,stroke-dasharray:5 5,color:#fff
  class AZ future
  
  %% Subgraph styling
  classDef subgraphStyle fill:#1e1e1e,stroke:#666,stroke-width:2px,color:#fff
  class EXT,INGEST,OBS,CLIENT subgraphStyle

