flowchart LR
  %% External real-world sources (Phase 1)
  subgraph EXT["External Public Sensors REST GET"]
    OS[openSenseMap API]
    SC[Sensor.Community API]
    USGS[USGS Water Services API]
  end

  %% On-prem lab (Docker Compose)
  subgraph LAB["Telemetry Kitchen - Docker Compose"]
    GP[Gateway.Poller .NET 10<br/>- polls external APIs<br/>- normalizes to SensorEvent<br/>- publishes to RabbitMQ<br/>- exposes metrics]
    MQ[(RabbitMQ<br/>Durability gate)]
    IC[Ingest.Consumer .NET 10<br/>- consumes queues<br/>- idempotency<br/>- writes Postgres<br/>- exposes metrics]
    DB[(PostgreSQL vanilla<br/>Single instance<br/>Naive baseline schema<br/>one big table first)]

    PROM[(Prometheus<br/>Scrapes metrics)]
    GRAF[Grafana<br/>Ops dashboards and alerts]
    META[Metabase<br/>Analytics and BI dashboards]
    MVC[Web.Mvc .NET 10 MVC<br/>Read-only UI Phase 1<br/>Sensors status history]

    %% Phase 2 (optional)
    AZ[(Azurite<br/>Azure Blob-compatible<br/>Local object storage<br/>Phase 2 for camera blobs)]

    %% Exporters (optional early, likely Phase 1.1)
    PGX[postgres_exporter]
    RMQX[rabbitmq_exporter]
    CAD[cAdvisor node-exporter<br/>CPU RAM Disk Net]
  end

  %% External -> Gateway
  OS -->|HTTP GET| GP
  SC -->|HTTP GET| GP
  USGS -->|HTTP GET| GP

  %% Ingestion pipeline
  GP -->|Publish SensorEvent| MQ
  MQ -->|Consume| IC
  IC -->|INSERT idempotent| DB

  %% UI Analytics read path
  MVC -->|read query| DB
  META -->|read query| DB

  %% Observability
  GP -->|metrics| PROM
  IC -->|metrics| PROM
  PGX --> PROM
  RMQX --> PROM
  CAD --> PROM
  PROM --> GRAF

  %% Exporter connections
  DB --> PGX
  MQ --> RMQX

  %% Phase 2: blobs
  GP -.->|store blob optional| AZ
  IC -.->|store blobRef checksum| DB
