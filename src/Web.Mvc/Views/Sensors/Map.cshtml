@model List<Web.Mvc.Repositories.SensorMapPoint>

@{
    ViewData["Title"] = "Sensor Map";
}

<h1 class="page-title">üåç Sensor World Map</h1>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Sensors with Location</h6>
                <h3 class="text-primary">@Model.Count()</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Total Events</h6>
                <h3 class="text-success">@Model.Sum(s => s.EventCount).ToString("N0")</h3>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="map-container" id="map"></div>
</div>

<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">Sensor List</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th width="40%">Name</th>
                    <th width="30%">Location</th>
                    <th width="15%">Events</th>
                    <th width="15%" class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">No sensors with location data</td>
                    </tr>
                }
                else
                {
                    @foreach (var sensor in Model.OrderByDescending(s => s.EventCount))
                    {
                        <tr>
                            <td>
                                <strong>@sensor.DisplayName</strong>
                                <br />
                                <small class="text-muted">@sensor.SensorId</small>
                            </td>
                            <td>
                                <small>@sensor.Lat.ToString("F4"), @sensor.Lon.ToString("F4")</small>
                            </td>
                            <td>
                                <span class="badge bg-info">@sensor.EventCount</span>
                            </td>
                            <td class="text-center">
                                <a href="@Url.Action("Detail", "Sensors", new { sensorId = sensor.SensorId })" class="btn btn-sm btn-primary">
                                    View
                                </a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        const mapData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
        
        // Initialize map
        const map = L.map('map').setView([20, 0], 2);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add markers for each sensor
        mapData.forEach(sensor => {
            const marker = L.marker([sensor.Lat, sensor.Lon]).addTo(map);
            const lastEvent = sensor.LastEventTime ? new Date(sensor.LastEventTime).toLocaleString() : 'Never';
            const measurements = (sensor.LastMeasurements || [])
                .map(m => `<li><strong>${m.Name}:</strong> ${m.Value}${m.Unit ? ' ' + m.Unit : ''}</li>`)
                .join('');
            const measurementsBlock = measurements
                ? `<ul class="mb-2" style="padding-left: 1rem;">${measurements}</ul>`
                : '<div class="text-muted">No measurements</div>';

            const tooltip = `
                <div style="min-width: 220px;">
                    <strong>${sensor.DisplayName}</strong><br />
                    <small class="text-muted">${sensor.SensorId}</small><br /><br />
                    <strong>Last Event:</strong> ${lastEvent}<br />
                    ${measurementsBlock}
                </div>
            `;

            const popup = `
                <div style="min-width: 250px;">
                    <strong>${sensor.DisplayName}</strong><br />
                    <small class="text-muted">${sensor.SensorId}</small><br /><br />
                    <strong>Location:</strong> ${sensor.Lat.toFixed(4)}, ${sensor.Lon.toFixed(4)}<br />
                    <strong>Events:</strong> ${sensor.EventCount.toLocaleString()}<br />
                    <strong>Last Event:</strong> ${lastEvent}<br /><br />
                    <a href="/Sensors/Detail?sensorId=${encodeURIComponent(sensor.SensorId)}" class="btn btn-sm btn-primary">View Details</a>
                </div>
            `;

            marker.bindTooltip(tooltip, { sticky: true });
            marker.bindPopup(popup);
        });
        
        // Auto-refresh every 60 seconds
        setTimeout(() => location.reload(), 60000);
    </script>
}
